name: Godot Builder

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]
env:
  GODOT_VERSION: 4.4.1
  PROJECT_NAME: loop-rama
jobs:
  windows-builder:
    runs-on: ubuntu-latest
    container:
      image: barichello/godot-ci:4.4.1
    steps:
    - uses: actions/checkout@v2
    - name: build-windows
      run: |
        godot -v -e --quit --headless
        mkdir -v -p ~/.local/share/godot/export_templates
        cp -r /root/.local/share/godot/export_templates/${GODOT_VERSION}.stable ~/.local/share/godot/export_templates/${GODOT_VERSION}.stable
        mkdir -v -p build/windows
        godot -v --export-release --headless "windows" build/windows/$PROJECT_NAME.exe
    - name: itchio-windows
      uses: manleydev/butler-publish-itchio-action@master
      env:
        BUTLER_CREDENTIALS: ${{ secrets.ITCH_IO_API_KEY }}
        CHANNEL: windows
        ITCH_GAME: ${{ env.PROJECT_NAME }}
        ITCH_USER: cristiadu
        PACKAGE: build/windows/${{ env.PROJECT_NAME }}.exe
  linux-builder:
    runs-on: ubuntu-latest
    container:
      image: barichello/godot-ci:4.4.1
    steps:
    - uses: actions/checkout@v2
    - name: build-linux
      run: |
        godot -v -e --quit --headless
        mkdir -v -p ~/.local/share/godot/export_templates
        cp -r /root/.local/share/godot/export_templates/${GODOT_VERSION}.stable ~/.local/share/godot/export_templates/${GODOT_VERSION}.stable
        mkdir -v -p build/linux
        godot -v --export-release --headless "linux" build/linux/$PROJECT_NAME.x86_64
    - name: itchio-linux
      uses: manleydev/butler-publish-itchio-action@master
      env:
        BUTLER_CREDENTIALS: ${{ secrets.ITCH_IO_API_KEY }}
        CHANNEL: linux
        ITCH_GAME: ${{ env.PROJECT_NAME }}
        ITCH_USER: cristiadu
        PACKAGE: build/linux/${{ env.PROJECT_NAME }}.x86_64
  macos-builder:
    runs-on: ubuntu-latest
    container:
      image: barichello/godot-ci:4.4.1
    steps:
    - uses: actions/checkout@v2
    - name: build-mac
      run: |
        godot -v -e --quit --headless
        mkdir -v -p ~/.local/share/godot/export_templates
        cp -r /root/.local/share/godot/export_templates/${GODOT_VERSION}.stable ~/.local/share/godot/export_templates/${GODOT_VERSION}.stable
        mkdir -v -p build/mac
        godot -v --export-release --headless "mac" build/mac/$PROJECT_NAME.app
    - name: itchio-mac
      uses: manleydev/butler-publish-itchio-action@master
      env:
        BUTLER_CREDENTIALS: ${{ secrets.ITCH_IO_API_KEY }}
        CHANNEL: mac
        ITCH_GAME: ${{ env.PROJECT_NAME }}
        ITCH_USER: cristiadu
        PACKAGE: build/mac/${{ env.PROJECT_NAME }}.app
  web-builder:
    runs-on: ubuntu-latest
    container:
      image: barichello/godot-ci:4.4.1
    steps:
    - uses: actions/checkout@v2
    - name: build-web
      run: |
        godot -v -e --quit --headless
        echo "=== Debug: Checking template locations ==="
        ls -la /root/.local/share/godot/export_templates/ || echo "No templates in /root/"
        find /root -name "*export_templates*" -type d 2>/dev/null || echo "No export_templates dirs in /root"
        echo "=== Debug: Creating user template directory ==="
        mkdir -v -p ~/.local/share/godot/export_templates
        echo "=== Debug: Copying templates ==="
        cp -r /root/.local/share/godot/export_templates/${GODOT_VERSION}.stable ~/.local/share/godot/export_templates/${GODOT_VERSION}.stable || echo "Failed to copy templates"
        echo "=== Debug: Checking copied templates ==="
        ls -la ~/.local/share/godot/export_templates/${GODOT_VERSION}.stable/ || echo "No templates found after copy"
        mkdir -v -p build/web
        godot -v --export-release --headless "Web" build/web/index.html
    - name: itchio-web
      uses: manleydev/butler-publish-itchio-action@master
      env:
        BUTLER_CREDENTIALS: ${{ secrets.ITCH_IO_API_KEY }}
        CHANNEL: html5
        ITCH_GAME: ${{ env.PROJECT_NAME }}
        ITCH_USER: cristiadu
        PACKAGE: build/web